<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClaudePad | Claude Code Monitor</title>
  <style>
    /* ============================================
     * SHEIKAH SLATE THEME
     * Ancient Futurism - Bronze & Cyan
     * ============================================ */
    :root {
      /* Background - Sheikah Slate colors */
      --slate-bg: #0a0a0f;
      --slate-bg-light: #111118;
      --slate-bg-lighter: #1a1a24;
      --slate-panel: #13131a;

      /* Bronze/Copper Ancient Metal */
      --bronze: #8B7355;
      --bronze-light: #A0826D;
      --bronze-dark: #6b5b4f;
      --bronze-dim: #4a3f37;

      /* Cyan Glow - Tech Energy */
      --cyan: #00d4ff;
      --cyan-bright: #00f0ff;
      --cyan-dim: #00a8cc;
      --cyan-glow: rgba(0, 212, 255, 0.3);

      /* Text */
      --text: #e0e0e0;
      --text-muted: #888;
      --text-dark: #666;

      /* Status Colors */
      --status-active: #00d4ff;
      --status-done: #4ade80;
      --status-error: #ef4444;
      --status-pending: #666;

      /* Typography */
      --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-full: 9999px;
    }

    /* ============================================
     * Reset & Base
     * ============================================ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--slate-bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* ============================================
     * Header / Navigation
     * ============================================ */
    .header {
      background: var(--slate-bg-light);
      border-bottom: 1px solid var(--bronze-dim);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .logo-icon {
      color: var(--cyan);
      font-size: 1.5rem;
      text-shadow: 0 0 10px var(--cyan-glow);
    }

    .logo-text {
      font-family: var(--font-mono);
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--bronze-light);
    }

    .nav-links {
      display: flex;
      gap: 12px;
    }

    .nav-link {
      color: var(--text-muted);
      text-decoration: none;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }

    .nav-link:hover {
      color: var(--cyan);
      background: var(--cyan-glow);
    }

    .nav-link.active {
      color: var(--cyan);
      border: 1px solid var(--cyan-dim);
    }

    /* ============================================
     * Buttons
     * ============================================ */
    .btn {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: transparent;
      color: var(--cyan);
      box-shadow: inset 0 0 0 1px var(--cyan-dim);
    }

    .btn-primary:hover {
      background: var(--cyan-glow);
      box-shadow: inset 0 0 0 1px var(--cyan), 0 0 20px var(--cyan-glow);
    }

    .btn-ghost {
      background: transparent;
      color: var(--bronze-light);
      box-shadow: inset 0 0 0 1px var(--bronze-dim);
      text-decoration: none;
    }

    .btn-ghost:hover {
      color: var(--cyan);
      box-shadow: inset 0 0 0 1px var(--cyan-dim);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    /* ============================================
     * Main Container
     * ============================================ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* ============================================
     * Sheikah Panel
     * ============================================ */
    .panel {
      background: var(--slate-panel);
      border: 1px solid var(--bronze-dim);
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--slate-bg-lighter);
      border-bottom: 1px solid var(--bronze-dim);
    }

    .panel-title {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--bronze-light);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-count {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* ============================================
     * Session List & Cards
     * ============================================ */
    .session-list {
      padding: 8px;
    }

    .session-card {
      background: var(--slate-bg-light);
      border: 1px solid var(--bronze-dim);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      margin: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .session-card:hover {
      border-color: var(--cyan-dim);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.1);
    }

    .session-info {
      flex: 1;
    }

    .session-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .session-status {
      width: 8px;
      height: 8px;
      border-radius: var(--radius-full);
      background: var(--text-muted);
      flex-shrink: 0;
    }

    .session-status.running {
      background: var(--cyan);
      box-shadow: 0 0 8px var(--cyan);
      animation: pulse 2s ease-in-out infinite;
    }

    .session-status.completed {
      background: var(--status-done);
    }

    .session-status.stopped {
      background: var(--status-error);
    }

    .session-id {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--bronze);
    }

    .session-name {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      margin: 8px 0;
    }

    .session-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .session-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .session-meta-label {
      color: var(--bronze-light);
    }

    .session-meta-value {
      color: var(--text);
    }

    /* ============================================
     * Loading & Empty States
     * ============================================ */
    .loading, .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--bronze-dim);
      border-top-color: var(--cyan);
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    .empty-icon {
      font-size: 2rem;
      color: var(--bronze);
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ============================================
     * Animations
     * ============================================ */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ============================================
     * Modal
     * ============================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--slate-panel);
      border: 1px solid var(--bronze);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: scaleIn 0.2s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--bronze-dim);
    }

    .modal-title {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--cyan);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .modal-close {
      background: transparent;
      border: 1px solid var(--bronze-dim);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      transition: all 0.2s;
    }

    .modal-close:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    /* ============================================
     * Modal Footer
     * ============================================ */
    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .empty-tip {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .empty-tip-icon {
      font-size: 2rem;
      color: var(--bronze);
      margin-bottom: 12px;
      opacity: 0.7;
    }

    /* ============================================
     * Scrollbar
     * ============================================ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--slate-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bronze-dim);
      border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--bronze);
    }

    /* ============================================
     * Config Bar - New UI Area
     * ============================================ */
    .config-bar {
      background: var(--slate-bg-lighter);
      border-bottom: 1px solid var(--bronze-dim);
      padding: 12px 20px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .config-label {
      font-size: 0.65rem;
      color: var(--bronze);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: var(--font-mono);
    }

    .config-value {
      font-size: 0.8rem;
      color: var(--text);
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .config-value .icon {
      color: var(--cyan);
      font-size: 0.9rem;
    }

    .config-value code {
      background: rgba(0, 212, 255, 0.1);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--bronze-dim);
    }

    /* ============================================
     * Model Config - Enhanced Design
     * ============================================ */
    .config-model-container {
      position: relative;
    }

    .config-model-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .config-model-row .item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: rgba(0, 212, 255, 0.08);
      border: 1px solid var(--bronze-dim);
      border-radius: var(--radius-sm);
    }

    .config-model-row .item:hover {
      border-color: var(--cyan-dim);
      background: rgba(0, 212, 255, 0.12);
    }

    .config-model-row .icon {
      color: var(--cyan);
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .config-model-row code {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text);
      background: transparent;
      border: none;
      padding: 0;
    }

    .config-model-row .divider {
      color: var(--bronze);
      font-size: 0.8rem;
      opacity: 0.5;
    }

    .btn-edit-model {
      background: transparent;
      border: 1px solid var(--bronze-dim);
      color: var(--bronze-light);
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-mono);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-edit-model:hover {
      border-color: var(--cyan);
      color: var(--cyan);
      box-shadow: 0 0 10px var(--cyan-glow);
    }

    /* ============================================
     * Edit Modal
     * ============================================ */
    .edit-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .edit-modal-overlay.active {
      display: flex;
    }

    .edit-modal {
      background: var(--slate-panel);
      border: 1px solid var(--bronze);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: scaleIn 0.2s ease-out;
    }

    .edit-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--bronze-dim);
    }

    .edit-modal-title {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--cyan);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .edit-modal-close {
      background: transparent;
      border: 1px solid var(--bronze-dim);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      transition: all 0.2s;
    }

    .edit-modal-close:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .edit-modal-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .edit-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .edit-form-label {
      font-size: 0.7rem;
      color: var(--bronze);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: var(--font-mono);
    }

    .edit-form-input {
      background: var(--slate-bg-light);
      border: 1px solid var(--bronze-dim);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .edit-form-input:focus {
      outline: none;
      border-color: var(--cyan);
      box-shadow: 0 0 10px var(--cyan-glow);
    }

    .edit-modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 16px;
      border-top: 1px solid var(--bronze-dim);
    }

    /* ============================================
     * Config Bar - New UI Area
     * ============================================ */
     </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/" class="logo">
      <span class="logo-icon">‚óà</span>
      <span class="logo-text">ClaudePad</span>
    </a>

    <div style="display: flex; gap: 8px; align-items: center;">
      <a href="/" class="nav-link active" style="color: var(--bronze-light);">üê± Sessions</a>
      <a href="/idea.html" class="nav-link" style="color: var(--bronze-light);">üí° Ideas</a>
      <a href="/tips.html" class="nav-link"  style="color: var(--bronze-light);">üîß Tips</a>
    </div>
  </header>

  <!-- Config Bar - New UI Area -->
  <div class="config-bar" id="config-bar">
    <div class="config-item">
      <span class="config-label">‚óà Claude Path</span>
      <span class="config-value" id="config-path"><span class="icon">‚ü≥</span> Loading...</span>
    </div>
    <div class="config-item config-model-container">
      <span class="config-label">Model Config</span>
      <div class="config-model-row">
        <div class="item">
          <span class="icon">‚óà</span>
          <code id="config-model">-</code>
        </div>
        <span class="divider">|</span>
        <button class="btn-edit-model" onclick="openEditModal()" title="Edit Model Configuration">‚úé Edit</button>
      </div>
    </div>
    <div class="config-item">
      <span class="config-label">Host / User</span>
      <span class="config-value" id="config-host-user"><span class="icon">‚óâ</span> <code id="config-host">-</code> <span style="color: var(--bronze);">|</span> <span class="icon">‚óà</span> <code id="config-user">-</code></span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="edit-modal-overlay" id="edit-modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="edit-modal">
      <div class="edit-modal-header">
        <span class="edit-modal-title">‚óà Edit Model Configuration</span>
        <button class="edit-modal-close" onclick="closeEditModal()">‚úï</button>
      </div>
      <div class="edit-modal-form">
        <div class="edit-form-group">
          <label class="edit-form-label">Model</label>
          <input type="text" class="edit-form-input" id="edit-model" placeholder="e.g. opus[1m]">
        </div>
        <div class="edit-form-group">
          <label class="edit-form-label">API URL</label>
          <input type="text" class="edit-form-input" id="edit-apiurl" placeholder="e.g. https://api.anthropic.com">
        </div>
        <div class="edit-form-group">
          <label class="edit-form-label">API Key</label>
          <input type="password" class="edit-form-input" id="edit-apikey" placeholder="sk-...">
        </div>
      </div>
      <div class="edit-modal-footer">
        <button class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container">
    <!-- Sessions Panel -->
    <section class="panel">
      <div class="panel-header">
        <span class="panel-title">‚óà Active Sessions</span>
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <!-- ÂàÜÈ°µÊéß‰ª∂ -->
          <div id="header-pagination" style="display: flex; align-items: center; gap: 6px; margin-right: 12px;">
            <button class="btn btn-ghost btn-sm" id="prev-btn" onclick="changePage(-1)" style="opacity:0.4;cursor:not-allowed;">‚Üê Prev</button>
            <span style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);" id="page-info">Page 1</span>
            <button class="btn btn-ghost btn-sm" id="next-btn" onclick="changePage(1)" style="opacity:0.4;cursor:not-allowed;">Next ‚Üí</button>
          </div>
          <!-- Áä∂ÊÄÅÁªüËÆ° -->
          <span id="status-stats" style="font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px;"></span>
          <span style="color: var(--bronze);">|</span>
          <!-- Session Êï∞Èáè -->
          <span id="count" class="panel-count">-</span>
          <span style="color: var(--bronze);">|</span>
          <!-- ÊÄªÊó∂Èïø -->
          <span id="total-duration" style="font-size: 0.75rem; color: var(--text-muted);"></span>
        </div>
      </div>
      <div id="list" class="session-list">
        <div class="loading">
          <div class="spinner"></div>
          <div>Fetching Claude sessions...</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ============================================
    // State
    // ============================================
    let currentConfig = {};
    let pagination = {
      offset: 0,
      limit: 20,
      total: 0
    };
    let refreshInterval;

    // ============================================
    // Config Functions
    // ============================================
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        currentConfig = config;

        document.getElementById('config-path').innerHTML = `<span class="icon">‚óà</span> <code>${escapeHtml(config.claudePath)}</code>`;
        document.getElementById('config-model').textContent = escapeHtml(config.model);
        document.getElementById('config-host').textContent = `${escapeHtml(config.ip)}:${config.port}`;
        document.getElementById('config-user').textContent = escapeHtml(config.user);
      } catch (error) {
        console.error('Failed to load config:', error);
        document.getElementById('config-path').textContent = 'Failed to load';
      }
    }

    function openEditModal() {
      document.getElementById('edit-model').value = currentConfig.model || '';
      document.getElementById('edit-apiurl').value = currentConfig.apiUrl || '';
      document.getElementById('edit-apikey').value = '';
      document.getElementById('edit-modal-overlay').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('edit-modal-overlay').classList.remove('active');
    }

    async function saveConfig() {
      const newConfig = {
        model: document.getElementById('edit-model').value,
        apiUrl: document.getElementById('edit-apiurl').value,
        apiKey: document.getElementById('edit-apikey').value
      };

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newConfig)
        });

        if (!response.ok) {
          throw new Error(await response.text());
        }

        closeEditModal();
        loadConfig();
        alert('Configuration saved successfully!');
      } catch (error) {
        alert('Failed to save configuration: ' + error.message);
      }
    }

    // ============================================
    // Session Functions
    // ============================================
    async function load() {
      const list = document.getElementById('list');
      const count = document.getElementById('count');
      const statusStats = document.getElementById('status-stats');

      // Â¶ÇÊûúÊòØÈ¶ñÊ¨°Âä†ËΩΩÊàñÂà∑Êñ∞ÔºåÊòæÁ§∫ loading
      if (!document.querySelector('.session-card')) {
        list.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <div>Fetching sessions...</div>
          </div>
        `;
      }

      try {
        const response = await fetch(`/api/sessions?limit=${pagination.limit}&offset=${pagination.offset}`);
        const data = await response.json();
        const sessions = data.sessions || [];
        pagination.total = data.pagination?.total || sessions.length;

        count.textContent = `${sessions.length} session${sessions.length !== 1 ? 's' : ''}`;

        // ÁªüËÆ°ÂêÑÁä∂ÊÄÅÊï∞Èáè
        const statusCounts = {
          running: 0,
          idle: 0,
          completed: 0,
          stopped: 0,
          unknown: 0
        };

        sessions.forEach(session => {
          const status = session.status;
          if (statusCounts.hasOwnProperty(status)) {
            statusCounts[status]++;
          } else {
            statusCounts.unknown++;
          }
        });

        // ÊòæÁ§∫Áä∂ÊÄÅÁªüËÆ°
        const statusLabels = {
          running: { text: 'Running', color: 'var(--status-active)' },
          idle: { text: 'Idle', color: 'var(--status-pending)' },
          completed: { text: 'Completed', color: 'var(--status-done)' },
          stopped: { text: 'Stopped', color: 'var(--status-error)' },
          unknown: { text: 'Unknown', color: 'var(--text-muted)' }
        };

        statusStats.innerHTML = Object.entries(statusCounts)
          .filter(([_, count]) => count > 0)
          .map(([status, count]) => {
            const label = statusLabels[status] || statusLabels.unknown;
            return `<span style="color: ${label.color}; display: flex; align-items: center; gap: 4px;">
              <span style="width: 6px; height: 6px; border-radius: 50%; background: ${label.color};"></span>
              ${count}
            </span>`;
          })
          .join('');

        if (sessions.length === 0) {
          list.innerHTML = `
            <div class="empty">
              <div class="empty-icon">‚óà</div>
              <p>No active sessions found</p>
              <p style="font-size: 0.85rem; margin-top: 8px; color: var(--text-muted);">
                Run "claude" in your terminal to start a session
              </p>
            </div>
          `;
          renderPagination();
          return;
        }

        // ÊåâÂºÄÂßãÊó∂Èó¥ÂÄíÂ∫èÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
        sessions.sort((a, b) => {
          const timeA = new Date(a.startTime).getTime();
          const timeB = new Date(b.startTime).getTime();
          return timeB - timeA;
        });

        // ÁªüËÆ°ÊÄª DurationÔºàÂä®ÊÄÅËÆ°ÁÆó running session ÁöÑ durationÔºâ
        const totalDuration = sessions.reduce((sum, s) => {
          let duration = s.duration || 0;
          // Â¶ÇÊûúÊòØ running Áä∂ÊÄÅÔºåÂä®ÊÄÅËÆ°ÁÆó duration
          if (s.status === 'running' && s.startTime) {
            const startTime = new Date(s.startTime).getTime();
            duration = Math.floor((Date.now() - startTime) / 1000);
          }
          return sum + duration;
        }, 0);

        // ÊòæÁ§∫ÊÄªÊåÅÁª≠Êó∂Èó¥Âà∞È°∂ÈÉ®
        document.getElementById('total-duration').innerHTML = `Total: <span style="color: var(--cyan); font-family: var(--font-mono);">${formatDurationSec(totalDuration)}</span>`;

        list.innerHTML = sessions.map(session => `
          <div class="session-card" onclick="viewSession('${escapeHtml(session.id)}')" data-session-id="${escapeHtml(session.id)}" data-status="${session.status}" data-start="${new Date(session.startTime).getTime()}">
            <div class="session-info">
              <div class="session-header">
                <span class="session-status ${session.status || ''}"></span>
                <span class="session-id">${escapeHtml(session.id)}</span>
              </div>
              <div class="session-name">${escapeHtml(session.name || 'Session')}</div>
              <div class="session-meta">
                <div class="session-meta-item">
                  <span class="session-meta-label">Status:</span>
                  <span class="session-meta-value">${getStatusText(session.status)}</span>
                </div>
                <div class="session-meta-item">
                  <span class="session-meta-label">Started:</span>
                  <span class="session-meta-value">${new Date(session.startTime).toLocaleString()}</span>
                </div>
                <div class="session-meta-item">
                  <span class="session-meta-label">Duration:</span>
                  <span class="session-meta-value duration" data-status="${session.status}" data-start="${new Date(session.startTime).getTime()}">${formatDurationWithStatus(session.duration, session.status, new Date(session.startTime).getTime())}</span>
                </div>
              </div>
            </div>
          </div>
        `).join('');

        renderPagination();

        // ÂêØÂä® Duration ÂÆûÊó∂Êõ¥Êñ∞
        startDurationUpdates();

      } catch (error) {
        list.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†</div>
            <p>Failed to load sessions</p>
            <button class="btn btn-primary" onclick="load()" style="margin-top: 16px;">Retry</button>
          </div>
        `;
      }
    }

    // Ê†ºÂºèÂåñ DurationÔºàÊîØÊåÅÂä®ÊÄÅËÆ°ÁÆóÔºâ
    function formatDurationWithStatus(staticDuration, status, startTimeMs) {
      let duration = staticDuration || 0;
      // Â¶ÇÊûúÊòØ running Áä∂ÊÄÅÔºåÂä®ÊÄÅËÆ°ÁÆó duration
      if (status === 'running' && startTimeMs) {
        duration = Math.floor((Date.now() - startTimeMs) / 1000);
      }
      return formatDurationSec(duration);
    }

    // ÂêØÂä® Duration ÂÆûÊó∂Êõ¥Êñ∞Ôºà‰ªÖÈíàÂØπ running sessionÔºâ
    function startDurationUpdates() {
      // Ê∏ÖÈô§‰πãÂâçÁöÑ intervalÔºàÂ¶ÇÊûúÊúâÔºâ
      if (window.durationUpdateInterval) {
        clearInterval(window.durationUpdateInterval);
      }

      // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨° running session ÁöÑ duration
      window.durationUpdateInterval = setInterval(() => {
        const durationElements = document.querySelectorAll('.duration[data-status="running"]');
        durationElements.forEach(el => {
          const startTimeMs = parseInt(el.getAttribute('data-start'));
          if (startTimeMs) {
            const duration = Math.floor((Date.now() - startTimeMs) / 1000);
            el.textContent = formatDurationSec(duration);
          }
        });

        // Êõ¥Êñ∞È°∂ÈÉ®ÁöÑÊÄª duration
        updateTotalDuration();
      }, 1000);
    }

    // Êõ¥Êñ∞ÊÄª duration
    function updateTotalDuration() {
      const durationElements = document.querySelectorAll('.duration[data-status="running"]');
      let runningTotal = 0;

      durationElements.forEach(el => {
        const startTimeMs = parseInt(el.getAttribute('data-start'));
        if (startTimeMs) {
          runningTotal += Math.floor((Date.now() - startTimeMs) / 1000);
        }
      });

      // Âä†‰∏ä completed/stopped session ÁöÑÈùôÊÄÅ duration
      const staticDurations = document.querySelectorAll('.duration:not([data-status="running"])');
      let staticTotal = 0;
      staticDurations.forEach(el => {
        const text = el.textContent;
        const parts = text.split(':').map(Number);
        if (parts.length === 3) {
          staticTotal += parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
      });

      const totalDuration = runningTotal + staticTotal;
      document.getElementById('total-duration').innerHTML = `Total: <span style="color: var(--cyan); font-family: var(--font-mono);">${formatDurationSec(totalDuration)}</span>`;
    }

    // Ê∏≤ÊüìÂàÜÈ°µÊéß‰ª∂ÔºàÂú® header ‰∏≠Ôºâ
    function renderPagination() {
      const currentPage = Math.floor(pagination.offset / pagination.limit) + 1;
      const totalPages = Math.ceil(pagination.total / pagination.limit) || 1;

      // Êõ¥Êñ∞È°µÈù¢‰ø°ÊÅØ
      document.getElementById('page-info').textContent = `Page ${currentPage} / ${totalPages}`;

      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      if (pagination.offset === 0) {
        prevBtn.style.opacity = '0.4';
        prevBtn.style.cursor = 'not-allowed';
        prevBtn.removeAttribute('onclick');
      } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
        prevBtn.setAttribute('onclick', 'changePage(-1)');
      }

      const hasNext = pagination.offset + pagination.limit < pagination.total;
      if (!hasNext) {
        nextBtn.style.opacity = '0.4';
        nextBtn.style.cursor = 'not-allowed';
        nextBtn.removeAttribute('onclick');
      } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
        nextBtn.setAttribute('onclick', 'changePage(1)');
      }
    }

    // Â§ÑÁêÜÂàÜÈ°µÊåâÈíÆÁÇπÂáª
    function changePage(delta) {
      const newOffset = pagination.offset + (delta * pagination.limit);
      if (newOffset >= 0 && newOffset < pagination.total) {
        pagination.offset = newOffset;
        load();
      }
    }

    function getStatusText(status) {
      const statusMap = {
        'running': 'Running',
        'completed': 'Completed',
        'stopped': 'Stopped'
      };
      return statusMap[status] || status || 'Unknown';
    }

    function formatDurationSec(secs) {
      if (secs === undefined || secs === null) return '-';
      const hours = Math.floor(secs / 3600);
      const minutes = Math.floor((secs % 3600) / 60);
      const seconds = secs % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function viewSession(id) {
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ terminal È°µÈù¢ÔºåÊó†ÈúÄÁ≠âÂæÖ
      // terminal È°µÈù¢‰ºöËá™Âä®ËøûÊé•ÊàñÂêØÂä® session
      window.location.href = `/terminal/${id}`;
    }

    // ============================================
    // Utilities
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // Initialization
    // ============================================
    // Á≠âÂæÖ DOM Âä†ËΩΩÂÆåÊàêÂêéÂÜçÂàùÂßãÂåñ
    (function init() {
      loadConfig();
      load();
    })();

    // Auto-refresh every 10 seconds
    setInterval(() => {
      // Ê∏ÖÈô§ duration Êõ¥Êñ∞ intervalÔºåÈÅøÂÖçÈáçÂ§ç
      if (window.durationUpdateInterval) {
        clearInterval(window.durationUpdateInterval);
      }
      load();
    }, 10000);
  </script>
</body>
</html>
